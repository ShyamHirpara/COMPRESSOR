{% extends 'web_compressor/base.html' %} {% block content %}
<div id="page-overlay">
    <div class="loader"></div>
    <p>Processing Image...</p>
</div>

<div class="card">
    <h1>Image Compressor</h1>
    <p style="color: #94a3b8; margin-bottom: 2rem">
        Reduce file sizes without losing quality.
    </p>

    <div id="error-message"></div>

    <form id="upload-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <div
            style="
                display: flex;
                flex-direction: column;
                gap: 1.5rem;
                margin-bottom: 2rem;
            "
        >
            <!-- Compression Level -->
            <div>
                <p
                    style="
                        margin-bottom: 0.5rem;
                        font-weight: 600;
                        color: var(--text);
                    "
                >
                    Compression Level
                </p>
                <div style="display: flex; justify-content: center; gap: 1rem">
                    <label class="radio-label">
                        <input
                            type="radio"
                            name="level"
                            value="normal"
                            checked
                        />
                        <span class="radio-custom">Normal</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="level" value="super" />
                        <span class="radio-custom">Super</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="level" value="ultra" />
                        <span class="radio-custom">Ultra</span>
                    </label>
                </div>
            </div>

            <!-- Output Format -->
            <div>
                <p
                    style="
                        margin-bottom: 0.5rem;
                        font-weight: 600;
                        color: var(--text);
                    "
                >
                    Output Format
                </p>
                <div style="display: flex; justify-content: center; gap: 1rem">
                    <label class="radio-label">
                        <input
                            type="radio"
                            name="format"
                            value="JPEG"
                            checked
                        />
                        <span class="radio-custom">JPEG</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="format" value="PNG" />
                        <span class="radio-custom">PNG</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="format" value="WEBP" />
                        <span class="radio-custom">WEBP</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="upload-area" id="drop-zone">
            <div style="font-size: 3rem; margin-bottom: 1rem">üìÅ</div>
            <p id="file-label">
                Drag & Drop your <strong>JPEG</strong> here or Click to Select
            </p>
            <input
                type="file"
                name="image"
                id="file-input"
                accept=".jpg,.jpeg"
                required
                onchange="updateFileLabel(this)"
            />
        </div>

        <button
            type="button"
            onclick="handleUpload()"
            class="btn"
            style="
                margin-top: 2rem;
                width: 100%;
                max-width: 300px;
                display: none;
            "
            id="compress-btn"
        >
            Compress Image üöÄ
        </button>
    </form>

    <!-- Dynamic Results Container -->
    <div id="results-container" style="display: none; margin-top: 3rem">
        <!-- Main Preview -->
        <div
            class="mini-card"
            style="
                border-color: var(--primary);
                margin-bottom: 2rem;
                max-width: 500px;
                margin-left: auto;
                margin-right: auto;
            "
        >
            <h3 style="margin-top: 0">Compressed Result</h3>
            <img
                id="preview-image"
                src=""
                alt="Preview"
                style="max-width: 100%; border-radius: 8px; margin-bottom: 1rem"
            />

            <div
                style="
                    display: flex;
                    justify-content: space-around;
                    align-items: center;
                    margin-bottom: 1rem;
                "
            >
                <div>
                    <div style="font-size: 0.9rem; opacity: 0.8">Format</div>
                    <div
                        style="font-weight: bold; color: var(--primary)"
                        id="result-format"
                    ></div>
                </div>
                <div>
                    <div style="font-size: 0.9rem; opacity: 0.8">New Size</div>
                    <div
                        style="font-weight: bold; color: var(--accent)"
                        id="result-size"
                    ></div>
                </div>
            </div>

            <a
                href="#"
                id="download-link"
                download
                class="btn btn-download"
                style="width: 100%"
            >
                Download <i class="fas fa-download"></i>
            </a>
        </div>
    </div>
</div>
{% endblock %} {% block extra_css %} /* Download Button Styles */ .btn-download
{ background: linear-gradient(135deg, var(--primary), var(--accent));
box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); padding: 1rem 2rem; font-size:
1.2rem; letter-spacing: 0.5px; display: flex; justify-content: center;
align-items: center; gap: 0.8rem; position: relative; overflow: hidden;
transition: all 0.3s ease; box-sizing: border-box; /* Fix overflow */ max-width:
100%; } /* Shine Effect */ .btn-download::after { content: ''; position:
absolute; top: 0; left: -100%; width: 100%; height: 100%; background:
linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
transition: 0.5s; } .btn-download:hover { transform: translateY(-3px);
box-shadow: 0 8px 25px rgba(236, 72, 153, 0.5); /* Accent color glow */ }
.btn-download:hover::after { left: 100%; } .btn-download i { transition:
transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); } .btn-download:hover i {
transform: translateY(3px) scale(1.1); } /* Page Freeze Overlay */ #page-overlay
{ position: fixed; top: 0; left: 0; width: 100%; height: 100%; /* Dark Mode
Default */ background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); z-index:
10000; display: none; justify-content: center; align-items: center;
flex-direction: column; cursor: progress; } [data-theme="light"] #page-overlay {
background: rgba(255, 255, 255, 0.5); } #page-overlay p { margin-top: 1rem;
font-weight: 600; color: white; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5); }
[data-theme="light"] #page-overlay p { color: var(--primary); text-shadow: none;
} /* Loader adjustments for overlay contrast */ [data-theme="light"]
#page-overlay .loader { border-color: rgba(0, 0, 0, 0.1); border-left-color:
var(--primary); } .upload-area { border: 2px dashed rgba(255, 255, 255, 0.2);
border-radius: 16px; padding: 3rem; cursor: pointer; transition: all 0.3s ease;
position: relative; overflow: hidden; margin-top: 2rem; z-index: 1; }
[data-theme="light"] .upload-area { border-color: rgba(0, 0, 0, 0.2); }
.upload-area:hover { border-color: var(--primary); background: rgba(99, 102,
241, 0.05); } .upload-area input[type="file"] { position: absolute; top: 0;
left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; } /* Loader
(Updated for overlay) */ .loader { border: 4px solid rgba(255, 255, 255, 0.1);
border-left-color: var(--primary); border-radius: 50%; width: 50px; height:
50px; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform:
rotate(0deg); } 100% { transform: rotate(360deg); } } /* Results & Recent */
.grid-results { display: grid; grid-template-columns: repeat(auto-fit,
minmax(200px, 1fr)); gap: 1.5rem; margin-top: 2rem; } .mini-card { background:
rgba(255, 255, 255, 0.05); border: 1px solid var(--border); padding: 1.5rem;
border-radius: 16px; text-align: center; position: relative; z-index: 50; }
[data-theme="light"] .mini-card { background: rgba(255, 255, 255, 0.5); } /*
Radio Buttons */ .radio-label { cursor: pointer; position: relative; z-index:
10; } .radio-label input { display: none; } .radio-custom { padding: 0.5rem
1.5rem; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border);
border-radius: 50px; transition: all 0.3s ease; display: inline-block;
font-weight: 600; color: var(--text); } [data-theme="light"] .radio-custom {
background: white; } .radio-label input:checked + .radio-custom { background:
var(--primary); border-color: var(--primary); transform: scale(1.05); color:
white; } #error-message { background: rgba(239, 68, 68, 0.2); border: 1px solid
rgba(239, 68, 68, 0.5); color: #fca5a5; padding: 1rem; border-radius: 8px;
margin-bottom: 2rem; display: none; } /* Recent Images Table */ .recent-table {
width: 100%; border-collapse: collapse; margin-top: 2rem; text-align: left; }
.recent-table th, .recent-table td { padding: 1rem; border-bottom: 1px solid
@media (max-width: 768px) { .upload-area { padding: 2rem; } #recent-section {
overflow-x: auto; } } {% endblock %} {% block extra_js %}
<script>
    function updateFileLabel(input) {
        const label = document.getElementById("file-label");
        const btn = document.getElementById("compress-btn");
        const formatSection = document.getElementById("format-section");
        if (input.files && input.files[0]) {
            label.innerHTML = `Selected: <strong>${input.files[0].name}</strong>`;
            btn.style.display = "inline-block";
            formatSection.style.display = "block";
        } else {
            label.innerHTML =
                "Drag & Drop your <strong>JPEG</strong> here or Click to Select";
            btn.style.display = "none";
            formatSection.style.display = "none";
        }
    }

    function handleUpload() {
        const form = document.getElementById("upload-form");
        const formData = new FormData(form);

        // Validation
        const fileInput = document.getElementById("file-input");
        if (!fileInput.files || !fileInput.files[0]) {
            alert("Please select a file first!");
            return;
        }

        const overlay = document.getElementById("page-overlay");
        const resultsContainer = document.getElementById("results-container");
        const errorMsg = document.getElementById("error-message");
        const compressBtn = document.getElementById("compress-btn");

        // Clear previous & Freeze UI
        resultsContainer.style.display = "none";
        errorMsg.style.display = "none";
        overlay.style.display = "flex"; // Show Overlay

        fetch('{% url "index" %}', {
            method: "POST",
            body: formData,
            headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": document.querySelector(
                    "[name=csrfmiddlewaretoken]",
                ).value,
            },
        })
            .then((response) => response.json())
            .then((data) => {
                overlay.style.display = "none"; // Unfreeze UI

                if (data.error) {
                    errorMsg.textContent = data.error;
                    errorMsg.style.display = "block";
                    return;
                }

                if (data.results && data.results.length > 0) {
                    const result = data.results[0];

                    // Update UI
                    document.getElementById("preview-image").src = result.url;
                    document.getElementById("result-format").textContent =
                        result.format;
                    document.getElementById("result-size").textContent =
                        result.size;

                    const downloadLink =
                        document.getElementById("download-link");
                    downloadLink.href = result.url;
                    downloadLink.download = result.filename;

                    // Do NOT Hide Form, Show Result Below
                    resultsContainer.style.display = "block";
                    resultsContainer.scrollIntoView({ behavior: "smooth" });
                }
            })
            .catch((err) => {
                overlay.style.display = "none";
                errorMsg.textContent = "An error occurred. Please try again.";
                errorMsg.style.display = "block";
                console.error(err);
            });
    }
</script>
{% endblock %}
