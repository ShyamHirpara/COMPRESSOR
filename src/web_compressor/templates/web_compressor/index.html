{% extends 'web_compressor/base.html' %} {% block content %}

<!-- Page Freeze Overlay -->
<div id="page-overlay">
    <div class="progress-ring-container">
        <svg class="progress-ring" width="120" height="120">
            <circle
                class="progress-ring__circle"
                stroke="white"
                stroke-width="4"
                fill="transparent"
                r="52"
                cx="60"
                cy="60"
            />
        </svg>
        <div class="loader-icon"></div>
    </div>
    <p id="overlay-text">Processing...</p>
    <p
        id="progress-text"
        style="
            font-size: 0.8rem;
            margin-top: 5px;
            color: rgba(255, 255, 255, 0.8);
        "
    >
        0%
    </p>
</div>

<div class="card">
    <h1>Image Compressor</h1>
    <p style="color: #94a3b8; margin-bottom: 2rem">
        Reduce file sizes without losing quality.
    </p>

    <div id="error-message"></div>

    <form id="compressor-form">
        {% csrf_token %}
        <input type="hidden" id="uploaded-filename" name="filename" value="" />

        <div
            style="
                display: flex;
                flex-direction: column;
                gap: 1.5rem;
                margin-bottom: 2rem;
            "
        >
            <!-- Compression Level -->
            <div>
                <p
                    style="
                        margin-bottom: 0.5rem;
                        font-weight: 600;
                        color: var(--text);
                    "
                >
                    Compression Level
                </p>
                <div style="display: flex; justify-content: center; gap: 1rem">
                    <label class="radio-label">
                        <input
                            type="radio"
                            name="level"
                            value="normal"
                            checked
                        />
                        <span class="radio-custom">Normal</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="level" value="super" />
                        <span class="radio-custom">Super</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="level" value="ultra" />
                        <span class="radio-custom">Ultra</span>
                    </label>
                </div>
            </div>

            <!-- Output Format -->
            <div>
                <p
                    style="
                        margin-bottom: 0.5rem;
                        font-weight: 600;
                        color: var(--text);
                    "
                >
                    Output Format
                </p>
                <div style="display: flex; justify-content: center; gap: 1rem">
                    <label class="radio-label">
                        <input
                            type="radio"
                            name="format"
                            value="JPEG"
                            checked
                        />
                        <span class="radio-custom">JPEG</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="format" value="PNG" />
                        <span class="radio-custom">PNG</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="format" value="WEBP" />
                        <span class="radio-custom">WEBP</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="upload-area" id="drop-zone">
            <div style="font-size: 3rem; margin-bottom: 1rem">üìÅ</div>
            <p id="file-label">
                Drag & Drop your <strong>JPEG</strong> here or Click to Select
            </p>
            <p style="font-size: 0.8rem; opacity: 0.7; margin-top: 5px">
                (Max size: 45MB)
            </p>
            <input
                type="file"
                name="image"
                id="file-input"
                accept=".jpg,.jpeg"
                onchange="handleFileSelect(this)"
            />
        </div>

        <button
            type="button"
            onclick="handleCompress()"
            class="btn"
            style="
                margin-top: 2rem;
                width: 100%;
                max-width: 300px;
                display: none;
            "
            id="compress-btn"
        >
            Compress Image üöÄ
        </button>
    </form>

    <!-- Dynamic Results Container -->
    <div id="results-container" style="display: none; margin-top: 3rem">
        <!-- Main Preview -->
        <div
            class="mini-card"
            style="
                border-color: var(--primary);
                margin-bottom: 2rem;
                max-width: 500px;
                margin-left: auto;
                margin-right: auto;
            "
        >
            <h3 style="margin-top: 0">Compressed Result</h3>
            <img
                id="preview-image"
                src=""
                alt="Preview"
                style="max-width: 100%; border-radius: 8px; margin-bottom: 1rem"
            />

            <div
                style="
                    display: flex;
                    justify-content: space-around;
                    align-items: center;
                    margin-bottom: 1rem;
                "
            >
                <div>
                    <div style="font-size: 0.9rem; opacity: 0.8">Format</div>
                    <div
                        style="font-weight: bold; color: var(--primary)"
                        id="result-format"
                    ></div>
                </div>
                <div>
                    <div style="font-size: 0.9rem; opacity: 0.8">New Size</div>
                    <div
                        style="font-weight: bold; color: var(--accent)"
                        id="result-size"
                    ></div>
                </div>
            </div>

            <a
                href="#"
                id="download-link"
                download
                class="btn btn-download"
                style="width: 100%"
            >
                Download <i class="fas fa-download"></i>
            </a>
        </div>
    </div>
</div>
{% endblock %} {% block extra_css %}
<style>
    /* Download Button Styles */
    .btn-download {
        background: linear-gradient(135deg, var(--primary), var(--accent));
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        padding: 1rem 2rem;
        font-size: 1.2rem;
        letter-spacing: 0.5px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.8rem;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        box-sizing: border-box; /* Fix overflow */
        max-width: 100%;
    }
    /* Shine Effect */
    .btn-download::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
            90deg,
            transparent,
            rgba(255, 255, 255, 0.3),
            transparent
        );
        transition: 0.5s;
    }
    .btn-download:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(236, 72, 153, 0.5); /* Accent color glow */
    }
    .btn-download:hover::after {
        left: 100%;
    }
    .btn-download i {
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .btn-download:hover i {
        transform: translateY(3px) scale(1.1);
    }

    /* Page Freeze Overlay */
    #page-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 10000;
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        cursor: progress;
    }
    [data-theme="light"] #page-overlay {
        background: rgba(255, 255, 255, 0.7);
    }
    #page-overlay p {
        margin-top: 1rem;
        font-weight: 600;
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }
    [data-theme="light"] #page-overlay p {
        color: var(--primary);
        text-shadow: none;
    }
    [data-theme="light"] #page-overlay #progress-text {
        color: var(--primary) !important;
    }

    /* Progress Ring */
    .progress-ring-container {
        position: relative;
        width: 120px;
        height: 120px;
    }
    .progress-ring__circle {
        transition: stroke-dashoffset 0.35s;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
        stroke-dasharray: 326.72; /* 2 * PI * r */
        stroke-dashoffset: 326.72;
        stroke: var(--primary);
    }
    [data-theme="light"] .progress-ring__circle {
        stroke: var(--primary);
    }

    .upload-area {
        border: 2px dashed rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        padding: 3rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        margin-top: 2rem;
        z-index: 1;
    }
    [data-theme="light"] .upload-area {
        border-color: rgba(0, 0, 0, 0.2);
    }
    .upload-area:hover {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.05);
    }
    .upload-area input[type="file"] {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    /* Results & Recent */
    .grid-results {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }
    .mini-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        padding: 1.5rem;
        border-radius: 16px;
        text-align: center;
        position: relative;
        z-index: 50;
    }
    [data-theme="light"] .mini-card {
        background: rgba(255, 255, 255, 0.5);
    }

    /* Radio Buttons */
    .radio-label {
        cursor: pointer;
        position: relative;
        z-index: 10;
    }
    .radio-label input {
        display: none;
    }
    .radio-custom {
        padding: 0.5rem 1.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--border);
        border-radius: 50px;
        transition: all 0.3s ease;
        display: inline-block;
        font-weight: 600;
        color: var(--text);
    }
    [data-theme="light"] .radio-custom {
        background: white;
    }
    .radio-label input:checked + .radio-custom {
        background: var(--primary);
        border-color: var(--primary);
        transform: scale(1.05);
        color: white;
    }
    #error-message {
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid rgba(239, 68, 68, 0.5);
        color: #fca5a5;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        display: none;
    }
    .recent-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 2rem;
        text-align: left;
    }
    .recent-table th,
    .recent-table td {
        padding: 1rem;
        border-bottom: 1px solid;
    } /* incomplete style kept from original */
    @media (max-width: 768px) {
        .upload-area {
            padding: 2rem;
        }
        #recent-section {
            overflow-x: auto;
        }
    }
</style>
{% endblock %} {% block extra_js %}
<script>
    // --- UI Helpers ---
    function setProgress(percent) {
        const circle = document.querySelector(".progress-ring__circle");
        const radius = circle.r.baseVal.value;
        const circumference = radius * 2 * Math.PI;

        circle.style.strokeDasharray = `${circumference} ${circumference}`;

        const offset = circumference - (percent / 100) * circumference;
        circle.style.strokeDashoffset = offset;

        document.getElementById("progress-text").textContent =
            Math.round(percent) + "%";
    }

    function showOverlay(text) {
        const overlay = document.getElementById("page-overlay");
        const overlayText = document.getElementById("overlay-text");
        const progressText = document.getElementById("progress-text");

        overlayText.textContent = text;
        overlay.style.display = "flex";

        if (text.toLowerCase().includes("uploading")) {
            progressText.style.display = "block";
            setProgress(0);
        } else {
            // For compressing, maybe indeterminate or just 100% loop
            progressText.style.display = "none";
            // Make it spin?
            const circle = document.querySelector(".progress-ring__circle");
            circle.style.strokeDashoffset = 0; // Solid circle
            // Add spin class if desired, but this is fine
        }
    }

    function hideOverlay() {
        document.getElementById("page-overlay").style.display = "none";
    }

    // --- Actions ---

    function handleFileSelect(input) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];
        const label = document.getElementById("file-label");
        const errorMsg = document.getElementById("error-message");
        const compressBtn = document.getElementById("compress-btn");

        // Reset
        errorMsg.style.display = "none";
        document.getElementById("results-container").style.display = "none";

        // --- Limit Check (45MB) ---
        const MAX_SIZE_MB = 45;
        const MAX_SIZE_BYTES = MAX_SIZE_MB * 1024 * 1024;

        if (file.size > MAX_SIZE_BYTES) {
            errorMsg.textContent = `File is too large! Maximum size is ${MAX_SIZE_MB}MB.`;
            errorMsg.style.display = "block";
            input.value = ""; // Clear the input
            label.innerHTML = "Upload Failed. File Too Large.";
            return;
        }

        // --- 1. Upload immediately ---
        showOverlay("Uploading image...");

        const formData = new FormData();
        formData.append("image", file);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "{% url 'upload_temp' %}", true);

        // CSRF Token
        const csrfToken = document.querySelector(
            "[name=csrfmiddlewaretoken]",
        ).value;
        xhr.setRequestHeader("X-CSRFToken", csrfToken);

        // Progress
        xhr.upload.onprogress = function (e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                setProgress(percentComplete);
            }
        };

        xhr.onload = function () {
            if (xhr.status === 200) {
                const data = JSON.parse(xhr.responseText);

                if (data.filename) {
                    // Success
                    hideOverlay();

                    // Update UI
                    label.innerHTML = `Selected: <strong>${file.name}</strong> <span style="color: #4ade80">‚úî Uploaded</span>`;
                    document.getElementById("uploaded-filename").value =
                        data.filename;
                    compressBtn.style.display = "inline-block";
                } else {
                    // Upload Error
                    hideOverlay();
                    errorMsg.textContent = data.error || "Upload failed.";
                    errorMsg.style.display = "block";
                    label.innerHTML = "Upload Failed. Try again.";
                }
            } else {
                hideOverlay();
                errorMsg.textContent = "Server error during upload.";
                errorMsg.style.display = "block";
            }
        };

        xhr.onerror = function () {
            hideOverlay();
            errorMsg.textContent = "Network error.";
            errorMsg.style.display = "block";
        };

        xhr.send(formData);
    }

    function handleCompress() {
        // Get user selections
        const fileInput = document.getElementById("uploaded-filename");
        const filename = fileInput.value;

        if (!filename) {
            alert("No file uploaded! Please upload an image first.");
            return;
        }

        const levelInput = document.querySelector(
            'input[name="level"]:checked',
        );
        const formatInput = document.querySelector(
            'input[name="format"]:checked',
        );

        const level = levelInput ? levelInput.value : "normal";
        const format = formatInput ? formatInput.value : "JPEG";

        const errorMsg = document.getElementById("error-message");
        const resultsContainer = document.getElementById("results-container");

        // Show overlay
        showOverlay("Compressing image...");

        // Prepare data
        const formData = new FormData();
        formData.append("filename", filename);
        formData.append("level", level);
        formData.append("format", format);

        const csrfTokenInput = document.querySelector(
            "[name=csrfmiddlewaretoken]",
        );
        const csrfToken = csrfTokenInput ? csrfTokenInput.value : "";

        // API Call
        fetch("{% url 'compress_image' %}", {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": csrfToken,
            },
        })
            .then((response) => response.json())
            .then((data) => {
                hideOverlay();

                if (data.error) {
                    errorMsg.textContent = data.error;
                    errorMsg.style.display = "block";
                } else if (data.results && data.results.length > 0) {
                    const result = data.results[0];

                    // Update specific elements
                    const previewImg = document.getElementById("preview-image");
                    const resultFormat =
                        document.getElementById("result-format");
                    const resultSize = document.getElementById("result-size");
                    const downloadLink =
                        document.getElementById("download-link");

                    if (previewImg) previewImg.src = result.url;
                    if (resultFormat) resultFormat.textContent = result.format;
                    if (resultSize) resultSize.textContent = result.size;

                    if (downloadLink) {
                        downloadLink.href = result.url;
                        downloadLink.setAttribute("download", result.filename); // Ensure filename is used
                    }

                    resultsContainer.style.display = "block";
                    resultsContainer.scrollIntoView({ behavior: "smooth" });
                }
            })
            .catch((error) => {
                console.error("Error:", error);
                hideOverlay();
                errorMsg.textContent =
                    "An error occurred during compression. Please try again.";
                errorMsg.style.display = "block";
            });
    }
</script>
{% endblock %}
